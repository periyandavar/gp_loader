name: PHP Unit Tests and SonarCloud Analysis

on: [pull_request]

jobs:
  test:
    name: Build and analyze
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0' # or your required PHP version

      - name: Install Composer dependencies
        run: composer install

      - name: Run PHPUnit with Xdebug Coverage
        run: |
          $env:XDEBUG_MODE = "coverage"
          vendor\bin\phpunit --coverage-clover coverage.xml

      - name: Install SonarScanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          Invoke-WebRequest -Uri "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-windows.zip" -OutFile "sonar-scanner.zip"
          Expand-Archive -Path "sonar-scanner.zip" -DestinationPath "C:\sonar-scanner"
          echo "C:\sonar-scanner\sonar-scanner-4.6.2.2472-windows\bin" >> $GITHUB_PATH

      - name: Run SonarScanner
        run: |
          sonar-scanner -Dsonar.projectKey=periyandavar_gp_loader -Dsonar.organization=periyandavar -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=YOUR_SONAR_TOKEN